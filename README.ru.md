# Tucha

[![CI](https://github.com/pozitronik/tucha/actions/workflows/ci.yml/badge.svg)](https://github.com/pozitronik/tucha/actions/workflows/ci.yml)
[![codecov](https://codecov.io/gh/pozitronik/tucha/branch/master/graph/badge.svg)](https://codecov.io/gh/pozitronik/tucha)
[![Go Report Card](https://goreportcard.com/badge/github.com/pozitronik/tucha)](https://goreportcard.com/report/github.com/pozitronik/tucha)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)

[English](README.md)

Открытая имплементация сервера и протокола облачного хранилища, совместимого с web API cloud.mail.ru.

[Описание API](API_SPEC.md)

## Быстрый старт

### Требования

- Go 1.24+

### Сборка и запуск

```bash
go build -o tucha ./cmd/tucha
./tucha -config config.yaml
```

Сервер автоматически создает базу данных и директорию хранилища при первом запуске.

## Конфигурация

Все настройки задаются в `config.yaml`. Переменные окружения не используются.

```yaml
server:
  host: "0.0.0.0"                        # Адрес привязки
  port: 8081                              # Порт
  external_url: "http://localhost:8081"   # Публичный URL для клиентов

admin:
  login: "admin"                          # Логин панели администратора
  password: "admin"                       # Пароль панели администратора

storage:
  db_path: "./data/tucha.db"             # Путь к файлу базы данных SQLite
  content_dir: "./data/storage"          # Директория контентно-адресуемого хранилища
  quota_bytes: 17179869184               # Квота по умолчанию в байтах (16 ГиБ)

logging:
  level: "info"                          # Уровень логирования

# Необязательно: переопределение URL отдельных эндпоинтов (по умолчанию вычисляются из external_url)
# endpoints:
#   api: "http://localhost:8081/api/v2"
#   oauth: "http://localhost:8081"
#   dispatcher: "http://localhost:8081/api/v2/dispatcher"
#   upload: "http://localhost:8081/upload"
#   download: "http://localhost:8081/get"
```

### Замечания по конфигурации

- **`admin.login` / `admin.password`** -- учетные данные панели администратора. Они не связаны с аккаунтами пользователей и используются только для веб-интерфейса администратора.
- **`storage.quota_bytes`** -- квота по умолчанию для новых пользователей, когда явная квота не указана. Изменение этого значения влияет только на будущих пользователей.
- **`endpoints.*`** -- необязательные параметры. Если не указаны, вычисляются из `external_url`. Задайте их явно, если сервер находится за обратным прокси с разными внутренними/внешними URL.
- Все пути (`db_path`, `content_dir`) относительны к рабочей директории, если не указаны абсолютные.
- Валидация при старте: `port` 1--65535, `quota_bytes` > 0, все обязательные поля непустые.

### Первый доступ

1. Откройте панель администратора `http://localhost:8081/admin`
2. Войдите с учетными данными из `config.yaml` (`admin.login` / `admin.password`)
3. Создайте пользовательские аккаунты через панель администратора
4. Подключите десктопный клиент к `http://localhost:8081`

## Архитектура

Чистая архитектура с принципами DDD. Корень композиции -- `cmd/tucha/main.go`.

```
cmd/tucha/                          Точка входа, сборка зависимостей
internal/
  config/                           Загрузка и валидация YAML-конфигурации
  domain/
    entity/                         Сущности: User, Node, Token, Content, Share, TrashItem
    repository/                     Интерфейсы репозиториев (порты)
    vo/                             Value Objects: CloudPath, ContentHash, NodeType, AccessLevel и др.
  application/
    port/                           Исходящие порты (ContentStorage, Hasher)
    service/                        Сервисы приложения (оркестрация use case)
  infrastructure/
    sqlite/                         Реализации репозиториев на SQLite
    contentstore/                   Дисковое контентно-адресуемое хранилище
    hasher/                         Реализация алгоритма хеширования mrCloud
  transport/
    httpapi/                        HTTP-обработчики, DTO, маршрутизация, панель администратора
```

### Зависимости между слоями

```
transport -> application/service -> domain/entity + domain/repository
                                 -> application/port
infrastructure -> domain/repository (реализует интерфейсы)
              -> application/port  (реализует интерфейсы)
cmd/tucha -> все (только корень композиции)
```

## Аутентификация

Сервер использует две независимые системы аутентификации.

### Аутентификация пользователей (OAuth2)

OAuth2 password grant flow для доступа десктопного клиента. Сервер выступает и как сервер авторизации, и как сервер ресурсов.

1. Клиент отправляет `POST /token` с данными формы: `client_id=cloud-win`, `grant_type=password`, `username=<email>`, `password=<password>`
2. Сервер возвращает `access_token`, `refresh_token`, `expires_in` (86400 секунд = 24 часа)
3. Все API-запросы включают `?access_token=<token>` как параметр запроса
4. Токены -- 64-символьные случайные hex-строки, сгенерированные через `crypto/rand`
5. Просроченные токены отклоняются со статусом 403

### Аутентификация администратора

Логин/пароль из конфигурации с bearer-токенами в памяти. Эндпоинты `/admin/*` используют эту систему. Учетные данные администратора задаются в `config.yaml` и не хранятся в базе данных.

## Хранилище

### Контентно-адресуемое файловое хранилище

Файлы хранятся по хешу в двухуровневой шардированной структуре директорий:

```
<content_dir>/<первые2>/<символы3-4>/<полный_хеш_40символов>
```

Пример: хеш `C172C6E2FF47284FF33F348FEA7EECE532F6C051` хранится по пути:

```
./data/storage/C1/72/C172C6E2FF47284FF33F348FEA7EECE532F6C051
```

Идентичное содержимое хранится единожды (дедупликация через подсчет ссылок в таблице `contents`).

### Алгоритм хеширования (mrCloud)

Два режима в зависимости от размера файла:

- **Маленькие файлы (< 21 байт):** Содержимое дополняется нулями до 20 байт и кодируется в hex (без криптографического хеша).
- **Большие файлы (>= 21 байт):** `SHA1("mrCloud" + содержимое + строка_размера)`, результат в верхнем регистре hex.

### Схема базы данных (SQLite)

Шесть таблиц:

| Таблица    | Назначение                                                                                                                    |
|------------|-------------------------------------------------------------------------------------------------------------------------------|
| `users`    | Аккаунты пользователей: id, email, пароль, флаг администратора, квота, дата создания                                          |
| `nodes`    | Виртуальная файловая система: id, user_id, parent_id, имя, путь, тип, размер, хеш, mtime, rev, grev, tree                     |
| `contents` | Реестр контента: хеш, размер, счетчик ссылок, дата создания                                                                   |
| `tokens`   | Токены аутентификации: id, user_id, access_token, refresh_token, csrf_token, expires_at                                       |
| `trash`    | Корзина: id, user_id, исходный путь, тип, хеш, размер, метаданные удаления                                                    |
| `shares`   | Общий доступ к папкам: id, владелец, путь, email приглашенного, уровень доступа, токен приглашения, информация о монтировании |

Схема создается автоматически. Миграции выполняются при запуске.

## Управление квотой

- Каждый пользователь имеет лимит `quota_bytes`
- Использование рассчитывается как сумма размеров всех файловых узлов пользователя
- Загрузки блокируются, когда `использовано + размер_файла > квота`
- Квота по умолчанию для новых пользователей берется из `storage.quota_bytes` в конфигурации
- Квота может быть задана индивидуально через API администратора (параметр `quota_bytes` при добавлении/редактировании)
- Текущее использование видно в панели администратора и через `GET /api/v2/user/space`

## Тестирование

```bash
go test ./internal/... -v -count=1
```

Детектор гонок для конкурентных тестов:

```bash
go test ./internal/application/service/ -run TestAdminAuth_concurrent -race
```

## Зависимости

| Пакет                  | Назначение                         |
|------------------------|------------------------------------|
| `gopkg.in/yaml.v3`     | Парсинг YAML-конфигурации          |
| `modernc.org/sqlite`   | Чистый Go-драйвер SQLite (без CGO) |
| Стандартная библиотека | Все остальное                      |

# Лицензия
[LICENSE: GNU GPL v3.0](LICENSE)